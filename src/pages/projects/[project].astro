---
import "../../styles/article.css";

import Card from "../../components/Card.astro";
import Layout from "../../layouts/Layout.astro";

import type { GetStaticPaths } from "astro";
import type { CollectionEntry } from "astro:content";
import { render } from "astro:content";
import { getCollection } from "astro:content";
import ImageGlow from "../../components/ImageGlow.astro";
import Icon from "../../components/Icon.astro";

interface Props {
  project: CollectionEntry<"projects">;
}

export const getStaticPaths = (async () => {
  const projects = await getCollection("projects");

  return projects.map((project) => ({
    params: { project: project.id },
    props: { project },
  }));
}) satisfies GetStaticPaths;

const { project: projectParam } = Astro.params;
const { project: projectFromProps } = Astro.props;

// In SSR mode, we might need to fetch the project if it's not in props
let project: CollectionEntry<"projects"> | undefined = projectFromProps;

if (!project && projectParam) {
  const projects = await getCollection("projects");
  project = projects.find((p) => p.id === projectParam) ?? undefined;
}

if (!project) {
  return Astro.redirect("/projects");
}

// TypeScript now knows project is defined after the redirect check
const projectData: CollectionEntry<"projects"> = project;

const { Content } = await render(projectData);
---

<Layout
  title={projectData.data.title}
  description={projectData.data.description}
  image={projectData.data.image}
  article={{
    createdAt: projectData.data.date,
  }}
>
  <div class="left" slot="left">
    <Card class="toc-card">
      <h2 class="no-mt">Info</h2>
      <ul class="overview-list">
        {
          projectData.data.info?.map((info) => {
            const Tag = info.link ? "a" : "div";
            return (
              <li>
                <Tag href={info.link} class="project-info-item">
                  <Icon
                    type={info.icon.type}
                    name={info.icon.name as any}
                    width={24}
                    height={24}
                    class="glow-icon"
                  />
                  <span>{info.text}</span>
                </Tag>
              </li>
            );
          })
        }
      </ul>
    </Card>
  </div>
  <article slot="right">
    <Card>
      <div class="article-header" id="_top">
        {
          projectData.data.image && (
            <ImageGlow
              quality={100}
              class="article-image"
              src={projectData.data.image}
              alt={projectData.data.title}
            />
          )
        }
        <div class="header">
          <div>
            <h1 class="no-mt article-h1">{projectData.data.title}</h1>
          </div>
          <div class="article-info">
            <span>{projectData.data.date.toLocaleDateString()}</span>
          </div>
        </div>
      </div>
      <Content />
      <hr class="end-of-article" />
      <a href="/projects" class="block-link">‚Üê Back to projects</a>
    </Card>
  </article>
</Layout>
<style>
  .project-info-item {
    display: flex;
    align-items: center;
    gap: 1rem;
  }
</style>
